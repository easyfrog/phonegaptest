function setCamera(e){camera.position.set(camData[e].position[0],camData[e].position[1],camData[e].position[2]),camera.rotation.set(camData[e].rotation[0],camData[e].rotation[1],camData[e].rotation[2]),controller.target.set(camData[e].target[0],camData[e].target[1],camData[e].target[2])}function alone(e,t){for(var o=e.meshes,a=0;a<o.length;a++)o[a].name==t?o[a].visible=!0:o[a].visible=!1}function showAll(e){for(var t=0;t<sh.root.meshes.length;t++)sh.root.meshes[t].visible=!0}function init(){renderer=new THREE.WebGLRenderer({antialias:!0,alpha:!0}),renderer.setClearColor(0,0),renderer.setSize(window.innerWidth,window.innerHeight),container.appendChild(renderer.domElement),scene=new THREE.Scene,scene.add(new THREE.AmbientLight(6316128)),camera=new THREE.PerspectiveCamera(45,container.offsetWidth/container.offsetHeight,1,3e3),controller=new THREE.OrbitControls(camera,renderer.domElement),setCamera("original"),projector=new THREE.Projector,sh=new SceneHandler("",scene,!1),sh.load("resources/model/sea3d/nubiaz9_h5_small.sea"),sh.onProgress=function(e){txt[0].innerHTML="模型载入: "+(100*e.progress).toFixed(1)+"%",drawCircle(e.progress)},sh.onComplete=function(){console.log("load completed!"),eu&&(eu.preventEvents=!1),edgeWorks();for(var e=sh.root.materials,t=0;t<e.length;t++)null!=e[t].map&&(e[t].emissive=new THREE.Color(.6,.6,.6));var o=new THREE.HemisphereLight({color:16777215});o.intensity=.4,scene.add(o),resize()}}function drawCircle(e){ctx.strokeStyle="red",ctx.lineWidth=4,ctx.lineCap="round",ctx.beginPath(),ctx.arc(ctn.width()/2,ctn.height()/2,ctn.width()/2-6,-Math.PI/2,2*Math.PI*e-Math.PI/2),ctx.stroke()}function edgeWorks(){stage.isLoaded=!0,stage.$("upc").show(),stage.getSymbol("sym1").$("pre").hide(),stage.play(-1),stage.getSymbol("sym1").play(-1),stage.sym6.$("free").bind("click touchend",function(){"normal"==state&&isopen&&supportWebGL&&(sh.play("open",-2,!1),isopen=!1)}),stage.sym6.$("explode").bind("click touchend",function(){!isopen&&supportWebGL&&(sh.play("open",2,!1),isopen=!0)}),stage.sym6.$("exit").bind("click touchend",function(){"normal"==state&&eu&&eu.slideLayer()}),document.addEventListener("keydown",function(e){console.log("key down : "+e.keyCode),(e.keyCode=32)&&console.log(camera,controller)}),stage.sym6.$("model").bind("mousedown touchstart",function(e){isAnimating||(clearInterval(_k),controller.autoRotate=!1,onMouseDown(e))}),stage.sym6.$("model").bind("mouseup touchend",function(e){isAnimating||(_k=setTimeout(function(){"normal"==state&&(controller.autoRotate=!0)},2e3),"normal"==state?onMouseUp(e):"alone"==state&&(stage.sym6.getSymbol(curName+"_t").playReverse(),camFlyTo(1,camData.tmp,ztc.Tween.easeOutQuad,function(){state="normal",stage.sym6.$("tt").hide(),showAll(sh.root),_k=setTimeout(function(){controller.autoRotate=!0},2e3)})))})}function onMouseDown(e){_lastMousePick=getPick(e)}function onMouseUp(e){e.preventDefault();var t=getPick(e);if(_lastMousePick.distanceTo(t)<5){var o=getPick(e),a=o.x/container.offsetWidth*2-1,n=2*-(o.y/container.offsetHeight)+1;console.log(o.x,o.y,container.offsetWidth,container.offsetHeight);var r=new THREE.Vector3(a,n,1);projector.unprojectVector(r,camera);var i=new THREE.Raycaster(camera.position,r.sub(camera.position).normalize()),s=i.intersectObjects(scene.children,!0);s.length>0&&(console.log("index -> picked event: ",s[0].object.name," param: object"),picked(s[0].object))}}function picked(e){inArray(oo,e.name)&&isopen&&objPicked(e.name)}function inArray(e,t){for(var o=0;o<e.length;o++)if(e[o]==t)return!0;return!1}function objPicked(e){"Object002"==e&&(e="screen"),state="alone",alone(sh.root,e),setTmp(),camFlyTo(1,camData[e]),stage.sym6.$("tt").show(),curName=e,stage.sym6.getSymbol(e+"_t").play(0)}function camFlyTo(e,t,o,a,n){isAnimating=!0,ztc.Tween.isDom=!1,e||(e=1),ztc.Tween.actionArrayProps([camera.position,camera.rotation,controller.target],e,[{x:t.position[0],y:t.position[1],z:t.position[2]},{x:t.rotation[0],y:t.rotation[1],z:t.rotation[2]},{x:t.target[0],y:t.target[1],z:t.target[2]}],ztc.Tween.easeOutBack,function(){isAnimating=!1,a&&a()},n)}function setTmp(){camData.tmp={position:[camera.position.x,camera.position.y,camera.position.z],rotation:[camera.rotation.x,camera.rotation.y,camera.rotation.z],target:[controller.target.x,controller.target.y,controller.target.z]}}function getPick(e){var t,o;if(0==e.type.indexOf("touch")){var a=e.originalEvent.changedTouches[0];t=a.pageX,o=a.pageY}else t=e.pageX,o=e.pageY;return new THREE.Vector2(t,o).divideScalar(eu.scale)}function update(){requestAnimationFrame(update),pause||(controller.update(),sh.update(),renderer.render(scene,camera))}function resize(){var e=eu?eu.scale:1,t=window.innerWidth/e,o=window.innerHeight/e;renderer&&renderer.setSize(t,o),camera&&(camera.aspect=t/o,camera.updateProjectionMatrix())}var supportWebGL=!0;Detector.webgl||(supportWebGL=!1),ztc.Tween.isDom=!1;var renderer,camera,scene,loader,controller,clock=new THREE.Clock,sh,stage,comp,container,isopen=!1,_k,txt,pause=!0,platform,projector,canvas=document.createElement("canvas"),ctx=canvas.getContext("2d"),ctn;AdobeEdge.bootstrapCallback(function(e){console.log("composition loaded!"),comp=AdobeEdge.getComposition(e),stage=comp.getStage(),stage.stop(0),platform=ztc.tools.getPlatform().platform,0!=platform.indexOf("i")&&(supportWebGL=!1,console.log("--->platform is not IOS")),container=stage.sym6.$("model")[0],eu&&(eu.preventEvents=!0,eu.thresholdDis=100,eu.slideReaction=!1),txt=stage.getSymbol("sym1").$("txt"),txt.show(),"Android"==platform&&(stage.sym6.$("Text")[0].innerHTML="您使用的为非IOS设备,WebGL的渲染能力不是很高,暂时不能查看3D模型"),supportWebGL?(eu&&(eu.addLayerEvent("page6","inover",function(){pause=!1,console.log("pause is false --> addLayerEvent")}),eu.addLayerEvent("page6","outstart",function(){pause=!0,console.log("pause is true --> addLayerEvent")})),ctn=stage.getSymbol("sym1").$("circleContainer"),ctn[0].appendChild(canvas),canvas.width=ctn.width(),canvas.height=ctn.height(),init(),update()):(edgeWorks(),eu&&(eu.preventEvents=!1),stage.sym6.$("fg").show())}),window.addEventListener("resize",resize,!1);var camData={original:{position:[226.79,-14.49,385.79],rotation:[-.04,.55,.02],target:[-8.24,-28.28,6.21]},battery:{position:[-279.76,8.72,-333.9],rotation:[-3.09,-.57,-3.12],target:[-51.83,-8.79,23.58]},screen:{position:[250.41,-16.85,323.91],rotation:[-.01,.79,.01],target:[-51.59,-21.14,25.87]},camera_front:{position:[133.57,117.01,119.68],rotation:[-.07,.7,.04],target:[13.47,107.37,-23.02]},camera_back:{position:[-130.55,122.27,-147.28],rotation:[-3.06,-.63,-3.1],target:[-20.19,110.69,2.94]},zhuban:{position:[143.31,-9.04,295.42],rotation:[.02,.45,-.01],target:[-14.51,-1.38,-32.29]},tmp:{position:[123.71,2.75,265.76],rotation:[.02,.45,-.01],target:[-18.72,9.65,-30]}},isAnimating=!1,_lastMousePick=new THREE.Vector2,state="normal",oo=["battery","camera_front","camera_back","zhuban","Object002"],curName="";